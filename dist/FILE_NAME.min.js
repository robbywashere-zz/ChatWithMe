/*! PROJECT_NAME - v0.1.0 - 2013-09-16
* http://PROJECT_WEBSITE/
* Copyright (c) 2013 YOUR_NAME; Licensed MIT */
!function(a){window.cBox=function(){var b={isScrollBottom:function(){return cBox.DOM.log[0].scrollHeight-cBox.DOM.log.scrollTop()==cBox.DOM.log.outerHeight()},DOM:{},toggle:function(a){"boolean"==typeof a&&Fireside.logic.misc.store.set("abled",a);var b=Fireside.logic.misc.store.get("abled");Fireside.logic.misc.store.set("abled",!b),console.log(b),b?control.socket.connected||control.restoreUser():control.socket.connected&&control.socket.disconnect()},init:function(){this.DOM.sentence_template=a('[data-attr="sentence"]'),this.DOM.info=a('[data-attr="info"]'),this.DOM.log=a('[data-attr="log"]'),this.DOM.titlebar=a('[data-attr="titlebar"]'),this.DOM["status-icon"]=a('[data-attr="status-icon"]'),this.DOM.textarea=a('[data-attr="textarea"]'),this.DOM["nickname-box"]=a('[data-attr="nickname-box"]'),this.DOM.nickname=a('[data-attr="nickname"]'),this.DOM.chatbox=a('[data-container="chatbox"]'),this.DOM["chatbox-title"]=a('[data-attr="chatbox-title"]'),this.DOM.title=a("title"),this.DOM["menu-button"]=a(".cwm-menu .menu-button"),this.DOM.menu=a(".cwm-menu-container"),this.DOM["menu-action"]=a(".cwm-menu [data-action]");var c=new UTIL.throttle(2e3,1,function(a){console.log(a)});this.DOM.log.scroll(function(){c("BLAH!").start()}),this.DOM["menu-button"].click(function(){return a(".cwm-menu-container").toggle(),!1}),this.DOM.menu.click(function(){a(this).hide()}),this.DOM["menu-action"].click(function(){var c=a(this).data("action");"clear"===c&&(Fireside.logic.misc.store.set("offlineLog",null),b.DOM.log.html("")),"disconnect"===c&&control.socket.disconnect(),"connect"===c&&control.restoreUser(),"toggle"===c&&b.toggle()}),CWM_SUPPORT_ALIAS&&this.DOM.titlebar.append(CWM_SUPPORT_ALIAS);var d=Fireside.logic.misc.store.get("chatbox-state")?!0:!1;d&&b.DOM.chatbox.removeClass("minimize"),this.DOM["chatbox-title"].click(function(){return d=!d,Fireside.logic.misc.store.set("chatbox-state",d),d?b.DOM.chatbox.removeClass("minimize"):(b.DOM.chatbox.addClass("minimize"),b.DOM.textarea.blur()),!1}),this.DOM.chatbox.click(function(){b.DOM.chatbox.find('input[type="text"]:visible, textarea:visible').first().focus(),b.notify(!1)}),this.DOM.textarea.focus(function(){}),a('[data-attr="sentence"]').remove(),null==Fireside.logic.misc.store.get("nickname")||null==Fireside.logic.misc.store.get("profile")?(this.DOM.nickname.bind("keydown",function(b){if(13===b.keyCode){var c=a(this).val();control.nickname(c),Fireside.logic.misc.store.set("nickname",c),cBox.DOM["nickname-box"].hide(),cBox.DOM.textarea.focus(),a(this).unbind("keydown"),control.registerConnect(control.createProfile());var d="Hello "+c+" ! Welcome :) ";return cBox.DOM.log.append(a("<em>"+d+"</em>")),!1}}),cBox.DOM["nickname-box"].show()):cBox.DOM["nickname-box"].hide(),a('[data-attr="textarea"]').keydown(function(b){if(13===b.keyCode&&!b.originalEvent.shiftKey){var c=a(this).val(),d=cBox.logMsg("Me",c);if(d){var e=control.sendMsg(c);e.error(function(){var a=!0;d.log(a),d.el.addClass("error")}).success(function(){d.log(!1)})}return a(this).val(""),!1}}),Fireside.logic.hooks.disconnected=function(){cBox.userStatus("offline"),cBox.DOM.info.show().text("You are not connected")},Fireside.logic.hooks.connecting=function(){cBox.showConnecting()},Fireside.logic.hooks.message=function(a,b){a==Strophe.getBareJidFromJid(control.socket.jid)?(a="Me",cBox.logMsg(a,b)):(cBox.notify(!0),cBox.logMsg(a,b))},Fireside.logic.hooks.connected=function(){cBox.offLogRestore()},Fireside.logic.hooks.statusChange=function(a,b){var c={away:"away",chat:"online",dnd:"busy",xa:"away",unavailable:"offline"};"unavailable"==b?cBox.DOM.info.show().text(a+" is offline, but you may still send messages"):(null!=Fireside.logic.misc.store.get("nickname")&&control.nickname(Fireside.logic.misc.store.get("nickname")),cBox.DOM.info.hide().text("")),cBox.userStatus(c[b])}},showConnecting:function(){cBox.userStatus("connecting");var a=Fireside.logic.hooks.connected;Fireside.logic.hooks.connected=function(){a(),cBox.DOM.info.hide().text("")}},notify:function(a){a&&!this.DOM.textarea.is(":focus")?cBox.titleAlert("New Message",!0):cBox.titleAlert(null,!1)},alternate:function(a,b){var c,d={};d.fn1=a,d.fn2=b;var e=[a,b],f=0;this.start=function(){return c=setInterval(function(){f++,f%=2,e[f]()},1e3),this},this.stop=function(){return clearInterval(c),"function"==typeof d.fn1&&d.fn1(),this}},titleAlert:function(){var a={};return a.stop=function(){},function(c,d){if(a.stop(),null!=c||d){var e=this.DOM.title.text(),f=c,g=this,h=function(){c&&g.DOM.title.text(e),b.DOM["chatbox-title"].removeClass("lightup")},i=function(){c&&g.DOM.title.text(f),b.DOM["chatbox-title"].addClass("lightup")};a=new this.alternate(h,i).start()}}}(),offLogSet:function(a,b,c){var d=25,e=Fireside.logic.misc.store.get("offlineLog")||[],f=[a,b];c&&f.push(c),e.unshift(f),e.length>0&&(e=e.slice(0,d)),Fireside.logic.misc.store.set("offlineLog",e)},offLogRestore:function(){var a=Fireside.logic.misc.store.get("offlineLog");a.reverse();for(var b in a){var c=a[b],d=c[0]||" ",e=c[1]||" ",f=cBox.logMsg(d,e).el;c[2]&&f.addClass("error")}},_newSentence:function(){return this.DOM.sentence_template.clone()},userStatus:function(a){this.DOM["status-icon"].attr("class","icon "+a)},trim:function(a){a=a.replace(/^\s+/,"");for(var b=a.length-1;b>=0;b--)if(/\S/.test(a.charAt(b))){a=a.substring(0,b+1);break}return a},offline:function(){return!0},logMsg:function(a,b){if("object"==typeof b){b.error;var b=b.msg}"undefined"==typeof store&&(store=!0);var c=cBox._newSentence();if(b=cBox.trim(b),0==b.length)return!1;var d=c.find('[data-attr="words"]'),e=d.text(b).html().replace(/\n/g,"<br/>");d.html(e),c.find('[data-attr="sender"]').html(a+":");var f=this.isScrollBottom();this.DOM.log.append(c),f&&(cBox.DOM.log[0].scrollTop=cBox.DOM.log[0].scrollHeight);var g={el:c,log:function(c){var d=!!c;cBox.offLogSet(a,b,d)}};return g}};return b}(),depsReady(function(){a(document).ready(function(){cBox.init()})}),CWM_DEPEND()}(window.jQuery);